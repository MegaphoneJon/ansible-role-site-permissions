# setfacl -m u:www-data:rx example.org
- name: Grant www-data user access to the parent folder
  acl:
    path: "{{ webroot }}/.."
    entity: www-data
    etype: user
    permissions: rx
    state: present
    recalculate_mask: no_mask
  become_user: root

# setfacl --recursive -m u:www-data:rx example.org/web
- name: Grant www-data user access to the webroot
  acl:
    path: "{{ webroot }}"
    entity: www-data
    etype: user
    permissions: rx
    recursive: yes
    state: present
    recalculate_mask: no_mask
  become_user: root

# setfacl --default --no-mask --recursive -m u:www-data:rx example.org/web
- name: Set default ACLs for files under the webroot
  acl:
    path: "{{ webroot }}"
    entity: www-data
    etype: user
    permissions: rx
    recursive: yes
    default: yes
    state: present
    recalculate_mask: no_mask
  become_user: root

# setfacl --default --no-mask --recursive -m g::rw example.org/web
- name: Set default ACLs for files under the webroot
  acl:
    path: "{{ webroot }}"
    entity: "{{ run_as_user }}"
    etype: group
    permissions: rw
    recursive: yes
    default: yes
    state: present
    recalculate_mask: no_mask
  become_user: root


- name: Set file owner
  file:
    path: "{{ webroot }}"
    owner: "{{ run_as_user }}"
    group: "{{ run_as_user }}"
    recurse: yes
  become_user: root

- name: Find all directories
  find:
    paths: "{{ webroot }}"
    file_type: directory
  register: directories
  tags: file-perm-debug

- name: Set sticky bit on directories
  file:
    path: "{{ item.path }}"
    mode: g+s
  become_user: root
  with_items: "{{ directories.files }}"
  tags: file-perm-debug